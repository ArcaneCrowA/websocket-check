<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Notifications - MySite</title>
        <link rel="stylesheet" href="assets/css/style.css" />
        <script src="assets/js/head.js"></script>
        <!-- SDK library connection -->
        <script
            async
            src="https://notification-sdk-test-v2.acsolutions.ai/dist/n9s.js"
        ></script>
    </head>
    <body>
        <header>
            <nav>
                <div class="logo">
                    <h1>MySite</h1>
                </div>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="notifications.html">Notifications</a></li>
                </ul>
                <div class="user-session" style="display: none">
                    <button id="logout-button" class="cta-button">
                        Logout
                    </button>
                </div>
            </nav>
        </header>

        <main>
            <section id="notifications" class="hero">
                <div class="hero-content">
                    <h2>Notifications</h2>
                    <div class="controls">
                        <button onclick="loadMessages()" class="cta-button">
                            Load Messages
                        </button>
                        <button onclick="getUnreadCount()" class="cta-button">
                            Get Unread Count
                        </button>
                        <span
                            id="unread-badge"
                            class="badge"
                            style="display: none"
                            >0</span
                        >
                    </div>
                    <div class="container">
                        <div class="messages-list" id="messagesList"></div>
                        <div class="message-content empty" id="messageContent">
                            Выберите сообщение для просмотра
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>&copy; 2025 MySite. No rights reserved.</p>
        </footer>

        <script src="assets/js/script.js"></script>
        <script src="assets/js/login.js"></script>
        <script>
            function getUserIdFromSession() {
                const n9sConfigString = sessionStorage.getItem("n9sConfig");
                if (n9sConfigString) {
                    const n9sConfig = JSON.parse(n9sConfigString);
                    return n9sConfig.user_id;
                }
                return null;
            }

            async function loadMessages() {
                try {
                    const userId = getUserIdFromSession();
                    if (!userId) {
                        console.error("User not logged in");
                        return;
                    }
                    const result = await window.n9s("inbox.getMessages", {
                        user_id: userId,
                        limit: 20,
                        offset: 0,
                    });

                    const messagesList =
                        document.getElementById("messagesList");
                    if (result && result.data) {
                        messagesList.innerHTML = result.data
                            .map(
                                (message) => `
          <div class="message-item ${message.is_read ? "" : "unread"}" onclick="showMessage('${message.id}')">
            <div class="title">${message.title}</div>
            <div class="content">${message.content}</div>
            <div class="date">${new Date(message.created_at).toLocaleString()}</div>
          </div>
        `,
                            )
                            .join("");
                    }
                } catch (error) {
                    console.error("Load messages error:", error);
                }
            }

            async function showMessage(messageId) {
                try {
                    const result = await window.n9s("inbox.getContent", {
                        message_id: messageId,
                    });
                    const messageContent =
                        document.getElementById("messageContent");
                    messageContent.innerHTML = result.html_content;

                    messageContent.classList.remove("empty");

                    await window.n9s("inbox.markAsRead", {
                        message_id: messageId,
                    });

                    const messageItem = document.querySelector(
                        `[onclick="showMessage('${messageId}')"]`,
                    );
                    if (messageItem) messageItem.classList.remove("unread");
                    await getUnreadCount();
                } catch (error) {
                    console.error("Load content error:", error);
                }
            }

            async function getUnreadCount() {
                try {
                    const userId = getUserIdFromSession();
                    if (!userId) {
                        console.error("User not logged in");
                        return;
                    }
                    const result = await window.n9s("inbox.getUnreadCount", {
                        user_id: userId,
                    });

                    const badge = document.getElementById("unread-badge");
                    badge.textContent = result.unread_count;
                    badge.style.display =
                        result.unread_count > 0 ? "inline-block" : "none";
                } catch (error) {
                    console.error("Unread count error:", error);
                }
            }
        </script>
    </body>
</html>
